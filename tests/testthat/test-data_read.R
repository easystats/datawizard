skip_on_cran()
skip_if_offline()

skip_if_not_installed("httr")
skip_if_not_installed("readxl")
skip_if_not_installed("haven")
skip_if_not_installed("readr")
skip_if_not_installed("data.table")
skip_if_not_installed("rio")


# csv -------------------------

test_that("data_read", {
  d <- data_read(
    "https://raw.githubusercontent.com/easystats/circus/master/data/bootstrapped.csv",
    verbose = FALSE
  )
  expect_identical(dim(d), c(10000L, 4L))
})



# csv -------------------------

test_that("data_read, skip_empty", {
  d <- data_read(
    "https://raw.githubusercontent.com/easystats/circus/master/data/test_skip_empty.csv",
    verbose = FALSE
  )
  expect_identical(ncol(d), 3L)
  expect_identical(colnames(d), c("Var1", "Var2", "Var3"))
})



# tsv -------------------------

temp_file <- tempfile(fileext = ".tsv")
request <- httr::GET("https://raw.github.com/easystats/circus/master/data/sample1.tsv")
httr::stop_for_status(request)
writeBin(httr::content(request, type = "raw"), temp_file)

test_that("data_read", {
  d <- data_read(
    temp_file,
    verbose = FALSE
  )
  expect_identical(nrow(d), 3L)
  expect_identical(colnames(d), c("a", "b", "c"))
  expect_identical(sum(vapply(d, is.numeric, FUN.VALUE = logical(1L))), 2L)
  expect_identical(sum(vapply(d, is.character, FUN.VALUE = logical(1L))), 1L)
})

unlink(temp_file)



# excel -------------------------

temp_file <- tempfile(fileext = ".xlsx")
request <- httr::GET("https://raw.github.com/easystats/circus/master/data/sample1.xlsx")
httr::stop_for_status(request)
writeBin(httr::content(request, type = "raw"), temp_file)

test_that("data_read", {
  d <- data_read(
    temp_file,
    verbose = FALSE
  )
  expect_identical(nrow(d), 3L)
  expect_identical(colnames(d), c("a", "b", "c"))
  expect_identical(sum(vapply(d, is.numeric, FUN.VALUE = logical(1L))), 2L)
  expect_identical(sum(vapply(d, is.character, FUN.VALUE = logical(1L))), 1L)
})

unlink(temp_file)



# Stata file -----------------------------------

temp_file <- tempfile(fileext = ".dta")
request <- httr::GET("https://raw.github.com/easystats/circus/master/data/stata_test.dta")
httr::stop_for_status(request)
writeBin(httr::content(request, type = "raw"), temp_file)

test_that("data_read", {
  d <- data_read(
    temp_file,
    verbose = FALSE
  )
  expect_identical(
    d,
    data.frame(
      mpg = c(21, 21, 22.8),
      cyl = c(6, 6, 4),
      disp = c(160, 160, 108)
    )
  )
})

unlink(temp_file)



# SAS file -----------------------------------

temp_file <- tempfile(fileext = ".sas7bdat")
request <- httr::GET("https://raw.github.com/easystats/circus/master/data/sas_test.sas7bdat")
httr::stop_for_status(request)
writeBin(httr::content(request, type = "raw"), temp_file)

test_that("data_read", {
  d <- data_read(
    temp_file,
    verbose = FALSE
  )
  expect_identical(
    d,
    data.frame(
      mpg = c(21, 21, 22.8),
      cyl = c(6, 6, 4),
      disp = c(160, 160, 108)
    )
  )
})

unlink(temp_file)



# SPSS file -----------------------------------

temp_file <- tempfile(fileext = ".sav")
request <- httr::GET("https://raw.github.com/easystats/circus/master/data/EFC.sav")
httr::stop_for_status(request)
writeBin(httr::content(request, type = "raw"), temp_file)

test_that("data_read", {
  d <- data_read(
    temp_file,
    verbose = FALSE
  )
  expect_identical(sum(vapply(d, is.factor, FUN.VALUE = logical(1L))), 15L)
  expect_identical(sum(vapply(d, is.numeric, FUN.VALUE = logical(1L))), 11L)
  expect_identical(
    levels(d$c172code),
    c(
      "low level of education",
      "intermediate level of education",
      "high level of education"
    )
  )
  expect_identical(
    attr(d$n4pstu, "labels"),
    c(
      `spouse/partner` = 1,
      child = 2,
      sibling = 3,
      `daughter or son -in-law` = 4
    )
  )
})

unlink(temp_file)



# SPSS file. 2 ---------------------------------

temp_file <- tempfile(fileext = ".sav")
request <- httr::GET("https://raw.github.com/easystats/circus/master/data/spss_test.sav")
httr::stop_for_status(request)
writeBin(httr::content(request, type = "raw"), temp_file)

test_that("data_read", {
  d <- data_read(
    temp_file,
    verbose = FALSE
  )
  expect_identical(
    d,
    structure(
      list(
        V1 = structure(
          1:4,
          levels = c("Eins", "Zwei", "Drei", "Vier"),
          class = "factor", label = "Variable 1"
        ),
        V2 = structure(
          c(2, 3, 4, 1),
          labels = c(Eins = 1, Zwei = 2, Drei = 3),
          label = "Variable 2"
        ),
        V3 = structure(
          c(3L, 2L, 1L, 4L),
          levels = c("Eins", "Zwei", "Drei", "Vier"),
          class = "factor", label = "Variable 3"
        )
      ),
      row.names = c(NA, -4L), class = "data.frame"
    )
  )
})

unlink(temp_file)



# zipped SPSS file -----------------------------------

temp_file <- tempfile(fileext = ".zip")
request <- httr::GET("https://raw.github.com/easystats/circus/master/data/EFC.zip")
httr::stop_for_status(request)
writeBin(httr::content(request, type = "raw"), temp_file)

test_that("data_read", {
  d <- data_read(
    temp_file,
    verbose = FALSE
  )
  expect_identical(sum(vapply(d, is.factor, FUN.VALUE = logical(1L))), 15L)
  expect_identical(sum(vapply(d, is.numeric, FUN.VALUE = logical(1L))), 11L)
})

test_that("data_read, convert_factors", {
  d <- data_read(
    temp_file,
    convert_factors = FALSE,
    verbose = FALSE
  )
  expect_identical(sum(vapply(d, is.factor, FUN.VALUE = logical(1L))), 0L)
  expect_identical(sum(vapply(d, is.numeric, FUN.VALUE = logical(1L))), 26L)
})

unlink(temp_file)




# SPSS file, many value labels  -----------------------------------

# Output validated against SPSS output from original dataset

temp_file <- tempfile(fileext = ".sav")
request <- httr::GET("https://raw.github.com/easystats/circus/master/data/spss_many_labels.sav")
httr::stop_for_status(request)
writeBin(httr::content(request, type = "raw"), temp_file)

test_that("data_read, convert many labels correctly", {
  d <- data_read(
    temp_file,
    verbose = FALSE
  )
  # all are factors by default
  expect_identical(
    vapply(d, class, character(1)),
    c(selv1 = "factor", c12 = "factor", c12a = "factor", c12c = "factor")
  )
  expect_identical(
    levels(d$selv1),
    c(
      "Vignette 1 weiblich (Gülsen E. Reinigungskraft B)", "Vignette 2 weiblich (Gülsen E. Anwältin B)",
      "Vignette 3 weiblich (Monika E. Reinigungskraft B)", "Vignette 4 weiblich (Monika E. Anwältin B)",
      "Vignette 5 männlich (Hasan E. Reinigungskraft B)", "Vignette 6 männlich (Hasan E. Anwalt B)",
      "Vignette 7 männlich (Martin E. Reinigungskraft B)", "Vignette 8 männlich (Martin E. Anwalt B)",
      "Vignette 9 weiblich (Gülsen E. Reinigungskraft E)", "Vignette 10 weiblich (Gülsen E. Anwältin E)",
      "Vignette 11 weiblich (Monika E. Reinigungskraft E)", "Vignette 12 weiblich (Monika E. Anwältin E)",
      "Vignette 13 männlich (Hasan E. Reinigungskraft E)", "Vignette 14 männlich (Hasan E. Anwalt E)",
      "Vignette 15 männlich (Martin E. Reinigungskraft E)", "Vignette 16 männlich (Martin E. Anwalt E)"
    )
  )
  out <- capture.output(data_tabulate(d$selv1))
  expect_identical(
    out,
    c(
      "d$selv1 <categorical>", "# total N=2413 valid N=2413", "",
      "Value                                              |   N | Raw % | Valid % | Cumulative %",
      "---------------------------------------------------+-----+-------+---------+-------------",
      "Vignette 1 weiblich (Gülsen E. Reinigungskraft B)  | 150 |  6.22 |    6.22 |         6.22",
      "Vignette 2 weiblich (Gülsen E. Anwältin B)         | 150 |  6.22 |    6.22 |        12.43",
      "Vignette 3 weiblich (Monika E. Reinigungskraft B)  | 150 |  6.22 |    6.22 |        18.65",
      "Vignette 4 weiblich (Monika E. Anwältin B)         | 151 |  6.26 |    6.26 |        24.91",
      "Vignette 5 männlich (Hasan E. Reinigungskraft B)   | 151 |  6.26 |    6.26 |        31.16",
      "Vignette 6 männlich (Hasan E. Anwalt B)            | 153 |  6.34 |    6.34 |        37.51",
      "Vignette 7 männlich (Martin E. Reinigungskraft B)  | 150 |  6.22 |    6.22 |        43.72",
      "Vignette 8 männlich (Martin E. Anwalt B)           | 150 |  6.22 |    6.22 |        49.94",
      "Vignette 9 weiblich (Gülsen E. Reinigungskraft E)  | 151 |  6.26 |    6.26 |        56.20",
      "Vignette 10 weiblich (Gülsen E. Anwältin E)        | 150 |  6.22 |    6.22 |        62.41",
      "Vignette 11 weiblich (Monika E. Reinigungskraft E) | 150 |  6.22 |    6.22 |        68.63",
      "Vignette 12 weiblich (Monika E. Anwältin E)        | 151 |  6.26 |    6.26 |        74.89",
      "Vignette 13 männlich (Hasan E. Reinigungskraft E)  | 155 |  6.42 |    6.42 |        81.31",
      "Vignette 14 männlich (Hasan E. Anwalt E)           | 150 |  6.22 |    6.22 |        87.53",
      "Vignette 15 männlich (Martin E. Reinigungskraft E) | 150 |  6.22 |    6.22 |        93.74",
      "Vignette 16 männlich (Martin E. Anwalt E)          | 151 |  6.26 |    6.26 |       100.00",
      "<NA>                                               |   0 |  0.00 |    <NA> |         <NA>"
    )
  )

  expect_identical(levels(d$c12), c("ja", "nein", "keine Angabe"))
  out <- capture.output(data_tabulate(d$c12))
  expect_identical(
    out,
    c(
      "Sind oder waren Sie schon einmal selbst von solchen Beschwerden betroffen? (d$c12) <categorical>",
      "# total N=2413 valid N=2413",
      "",
      "Value        |    N | Raw % | Valid % | Cumulative %",
      "-------------+------+-------+---------+-------------",
      "ja           |  786 | 32.57 |   32.57 |        32.57",
      "nein         | 1616 | 66.97 |   66.97 |        99.54",
      "keine Angabe |   11 |  0.46 |    0.46 |       100.00",
      "<NA>         |    0 |  0.00 |    <NA> |         <NA>"
    )
  )

  expect_identical(levels(d$c12a), c("Filter", "ja", "nein", "keine Angabe"))
  out <- capture.output(data_tabulate(d$c12a))
  expect_identical(
    out,
    c(
      "Haben Sie deswegen Behandlung(en) in Anspruch genommen? (d$c12a) <categorical>",
      "# total N=2413 valid N=2413",
      "",
      "Value        |    N | Raw % | Valid % | Cumulative %",
      "-------------+------+-------+---------+-------------",
      "Filter       | 1627 | 67.43 |   67.43 |        67.43",
      "ja           |  500 | 20.72 |   20.72 |        88.15",
      "nein         |  285 | 11.81 |   11.81 |        99.96",
      "keine Angabe |    1 |  0.04 |    0.04 |       100.00",
      "<NA>         |    0 |  0.00 |    <NA> |         <NA>"
    )
  )
  expect_identical(
    levels(d$c12c),
    c(
      "Filter", "0 = keine", "1", "2", "3", "4", "5", "6", "7", "8",
      "9", "10 = sehr starke", "weiß nicht / keine Angabe"
    )
  )
  out <- capture.output(data_tabulate(d$c12c))
  expect_identical(
    out,
    c(
      "Wie sehr haben diese Behandlung(en) Ihre Beeinträchtigung durch die Beschwerden verbessert? (d$c12c) <categorical>",
      "# total N=2413 valid N=2413",
      "",
      "Value                     |    N | Raw % | Valid % | Cumulative %",
      "--------------------------+------+-------+---------+-------------",
      "Filter                    | 1913 | 79.28 |   79.28 |        79.28",
      "0 = keine                 |   34 |  1.41 |    1.41 |        80.69",
      "1                         |    2 |  0.08 |    0.08 |        80.77",
      "2                         |   11 |  0.46 |    0.46 |        81.23",
      "3                         |   14 |  0.58 |    0.58 |        81.81",
      "4                         |   19 |  0.79 |    0.79 |        82.59",
      "5                         |   61 |  2.53 |    2.53 |        85.12",
      "6                         |   42 |  1.74 |    1.74 |        86.86",
      "7                         |   63 |  2.61 |    2.61 |        89.47",
      "8                         |   97 |  4.02 |    4.02 |        93.49",
      "9                         |   53 |  2.20 |    2.20 |        95.69",
      "10 = sehr starke          |   99 |  4.10 |    4.10 |        99.79",
      "weiß nicht / keine Angabe |    5 |  0.21 |    0.21 |       100.00",
      "<NA>                      |    0 |  0.00 |    <NA> |         <NA>"
    )
  )
})

test_that("data_read, convert many labels correctly", {
  d <- data_read(
    temp_file,
    convert_factors = FALSE,
    verbose = FALSE
  )
  # all are factors by default
  expect_identical(
    vapply(d, class, character(1)),
    c(selv1 = "numeric", c12 = "numeric", c12a = "numeric", c12c = "numeric")
  )
  out <- capture.output(table(d$selv1))
  expect_identical(
    out,
    c(
      "",
      "  1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16 ",
      "150 150 150 151 151 153 150 150 151 150 150 151 155 150 150 151 "
    )
  )
  expect_identical(
    attributes(d$selv1)$labels,
    c(
      `Vignette 1 weiblich (Gülsen E. Reinigungskraft B)` = 1, `Vignette 2 weiblich (Gülsen E. Anwältin B)` = 2,
      `Vignette 3 weiblich (Monika E. Reinigungskraft B)` = 3, `Vignette 4 weiblich (Monika E. Anwältin B)` = 4,
      `Vignette 5 männlich (Hasan E. Reinigungskraft B)` = 5, `Vignette 6 männlich (Hasan E. Anwalt B)` = 6,
      `Vignette 7 männlich (Martin E. Reinigungskraft B)` = 7, `Vignette 8 männlich (Martin E. Anwalt B)` = 8,
      `Vignette 9 weiblich (Gülsen E. Reinigungskraft E)` = 9, `Vignette 10 weiblich (Gülsen E. Anwältin E)` = 10,
      `Vignette 11 weiblich (Monika E. Reinigungskraft E)` = 11, `Vignette 12 weiblich (Monika E. Anwältin E)` = 12,
      `Vignette 13 männlich (Hasan E. Reinigungskraft E)` = 13, `Vignette 14 männlich (Hasan E. Anwalt E)` = 14,
      `Vignette 15 männlich (Martin E. Reinigungskraft E)` = 15, `Vignette 16 männlich (Martin E. Anwalt E)` = 16,
      `99` = 99
    )
  )

  out <- capture.output(table(d$c12))
  expect_identical(
    out,
    c(
      "",
      "   1    2   99 ",
      " 786 1616   11 "
    )
  )
  expect_identical(attributes(d$c12)$labels, c(Filter = -2, ja = 1, nein = 2, `keine Angabe` = 99))

  out <- capture.output(table(d$c12a))
  expect_identical(
    out,
    c(
      "",
      "  -2    1    2   99 ",
      "1627  500  285    1 "
    )
  )
  expect_identical(attributes(d$c12a)$labels, c(Filter = -2, ja = 1, nein = 2, `keine Angabe` = 99))

  out <- capture.output(table(d$c12c))
  expect_identical(
    out,
    c(
      "",
      "  -2    0    1    2    3    4    5    6    7    8    9   10   99 ",
      "1913   34    2   11   14   19   61   42   63   97   53   99    5 "
    )
  )
  expect_identical(
    attributes(d$c12c)$labels,
    c(
      Filter = -2, `0 = keine` = 0, `1` = 1, `2` = 2, `3` = 3, `4` = 4,
      `5` = 5, `6` = 6, `7` = 7, `8` = 8, `9` = 9, `10 = sehr starke` = 10,
      `weiß nicht / keine Angabe` = 99
    )
  )
})

unlink(temp_file)
